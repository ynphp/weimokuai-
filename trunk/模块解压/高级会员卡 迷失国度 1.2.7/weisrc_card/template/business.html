{template 'common/header'}
{php echo $this -> set_tabbar($action, 2);}
<div class="main">
    <form action="" method="post" class="form-horizontal form" enctype="multipart/form-data">
        <div class="panel panel-default">
            <div class="panel-heading">
                {$title}
            </div>
            <div class="panel-body">
                <div class="form-group">
                    <label class="col-xs-12 col-sm-3 col-md-2 control-label">商家名称</label>
                    <div class="col-sm-9">
                        <input type="text" name="title" value="{$reply['title']}" id="title" class="form-control"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-xs-12 col-sm-3 col-md-2 control-label">封面消息</label>
                    <div class="col-sm-9">
                        <!--<input type="text" name="info" id="info"-->
                               <!--value="{if empty($reply)}微时代会员卡，方便携带收藏，永不挂失{else}{$reply['info']}{/if}" class="form-control">
                    <!--</div>-->
                <!--</div>-->
                <!--<div class="form-group">-->
                    <!--<label class="col-xs-12 col-sm-3 col-md-2 control-label">商家类别</label>-->
                    <!--<div class="col-sm-4">-->
                        <!--<select name="category_f" id="category_f" class="form-control"></select>-->
                    <!--</div>-->
                    <!--<div class="col-sm-4">-->
                        <!--<select name="category_s" id="category_s" class="form-control"></select>-->
                        <!--<script type="text/javascript" src="../addons/weisrc_dish/template/js/category.js"></script>-->
                        <!--<script type="text/javascript">-->
                            <!--var category_f = "{$reply['category_f']}";-->
                            <!--var category_s = "{$reply['category_s']}";-->
                        <!--</script>-->
                        <!--<script type="text/javascript">-->
                            <!--new CS("category_f", "category_s", category_f, category_s, '美食-1$本帮江浙菜-11,川菜-12,粤菜-13,湘菜-14,贵州菜-15,东北菜-16,台湾菜-17,新疆/清真菜-18,西北菜-19,素菜-20,火锅-21,自助餐-22,小吃快餐-23,日本-24,韩国料理-25,东南亚菜-26,西餐-27,面包甜点-28,其他-29#休闲娱乐-2$密室-30,咖啡厅-31,酒吧-32,茶馆-33,KTV-34,电影院-35,文化艺术-36,景点/郊游-37,公园-38,足疗按摩-39,洗浴-40,游乐游艺-41,桌球-42,桌面游戏-43,DIY手工坊-44,其他-45#购物-3$综合商场-46,食品茶酒-47,服饰鞋包-48,珠宝饰品-49,化妆品-50,运动户外-51,亲子购物-52,品牌折扣店-53,数码家电-54,家居建材-55,特色集市-56,书店-57,花店-58,眼镜店-59,超市/便利店-60,药店-61,其他-62#丽人-4$美发-63,美容/SPA-64,化妆品-65,瘦身纤体-66,美甲-67,瑜伽-68,舞蹈-69,个性写真-70,整形-71,齿科-72,其他-73#结婚-5$婚纱摄影-74,婚宴-75,婚戒首饰-76,婚纱礼服-77,婚庆公司-78,彩妆造型-79,司仪主持-80,婚礼跟拍-81,婚车租赁-82,婚礼小商品-83,婚房装修-84,其他-85#亲子-6$幼儿教育-86,亲子摄影-87,亲子游乐-88,亲子购物-89,孕产护理-90,其他-91#运动健身-7$游泳馆-92,羽毛球馆-93,健身中心-94,瑜伽-95,舞蹈-96,篮球场-97,网球场-98,足球场-99,高尔夫场-100,保龄球馆-101,桌球馆-102,乒乓球馆-103,武术场馆-104,体育场馆-105,其他-106#酒店-8$五星级酒店-107,四星级酒店-108,三星级酒店-109,经济型酒店-110,公寓式酒店-111,精品酒店-112,青年旅舍-113,度假村-114,其他-115#爱车-9$4S店/汽车销售-116,汽车保险-117,维修保养-118,配件/车饰-119,驾校-120,汽车租赁-121,停车场-122,加油站-123,其他-124#生活服务-10$旅行社-125,培训-126,室内装潢-127,宠物-128,齿科-129,快照/冲印-130,家政-131,银行-132,学校-133,团购网站-134,其他-135#其他-11$其他-136');-->
                        <!--</script>-->
                    <!--</div>-->
                <!--</div>-->
                <!--<div class="form-group">-->
                    <!--<label class="col-xs-12 col-sm-3 col-md-2 control-label">商家简介</label>-->
                    <!--<div class="col-sm-9">-->
                        <!--<textarea class="form-control richtext" name="content" cols="70" id="reply-add-text">{$reply['content']}</textarea>-->
                    <!--</div>-->
                <!--</div>-->
                <div class="form-group">
                    <label class="col-xs-12 col-sm-3 col-md-2 control-label">电话</label>
                    <div class="col-sm-9">
                        <input type="text" name="tel" id="tel" value="{$reply['tel']}" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-xs-12 col-sm-3 col-md-2 control-label">地址</label>
                    <div class="col-sm-9">
                        <input type="text" name="address" id="address" value="{$reply['address']}" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-xs-12 col-sm-3 col-md-2 control-label">商家所在地区</label>

                        <div class="col-sm-3">
                            <select name="location_p" id="location_p" class="location form-control"></select>
                        </div>
                            <div class="col-sm-3">
                        <select name="location_c" id="location_c" class="location form-control"></select>
                            </div>
                                <div class="col-sm-3">
                        <select name="location_a" id="location_a" class="location form-control"></select>
                                </div>
                        <script type="text/javascript" src="../addons/weisrc_card/template/js/region_select.js"></script>
                        <script type="text/javascript">
                            var location_p = "{if !empty($reply['location_p'])}{$reply['location_p']}{else}广东省{/if}";
                            var location_c = "{if !empty($reply['location_c'])}{$reply['location_c']}{else}汕头市{/if}";
                            var location_a = "{if !empty($reply['location_a'])}{$reply['location_a']}{else}龙湖区{/if}";
                            new PCAS("location_p", "location_c", "location_a", location_p, location_c, location_a);
                        </script>

                </div>
                <div class="form-group">
                    <label class="col-xs-12 col-sm-3 col-md-2 control-label">经纬度</label>
                    <div class="col-sm-9">
                        <div class="input-append">
                            <input type="text" id="place" class="form-control" style="width: 200px;display: inline" name="place" value="{if empty($reply)}汕头市龙湖区长平路127号{else}{$reply['place']}{/if}" data-rule-required="true">
                            <button class="btn" type="button" id="positioning" onclick="bmap.searchMapByAddress($('#place').val())">搜索</button>
                        </div>
                        <span class="maroon" style="color: #f30;margin-left: 5px;">注意：这个只是模糊定位，准确位置请地图上标注!</span>
                        <div id="l-map" style="overflow: hidden; position: relative; z-index: 0; background-image: url(http://api.map.baidu.com/images/bg.png);width: 500px; height: 300px;margin-top: 10px; color: rgb(0, 0, 0); text-align: left;"></div>
                        <div id="r-result">
                            <input type="text" id="lat" name="lat" class="form-control" style="width:200px;display: inline;" /> <input type="text" id="lng" name="lng" style="width:200px;display: inline;" class="form-control"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-12">
                <input name="submit" type="submit" value="保存设置" class="btn btn-primary span3">
                <input type="hidden" name="token" value="{$_W['token']}"/>
            </div>
        </div>
    </form>
</div>
<script type="text/javascript" src="./resource/script/kindeditor/kindeditor-min.js"></script>
<script type="text/javascript" src="./resource/script/kindeditor/lang/zh_CN.js"></script>
<link type="text/css" rel="stylesheet" href="./resource/script/kindeditor/themes/default/default.css"/>
<script>
    var editor = KindEditor.editor({
        allowFileManager: true,
        uploadJson: "./index.php?act=attachment&do=upload",
        fileManagerJson: "./index.php?act=attachment&do=manager",
        afterUpload: function (url, data) {
        }
    });
    $("#upload-image-logo").click(function () {
        editor.loadPlugin("image", function () {
            editor.plugin.imageDialog({
                tabIndex: 1,
                imageUrl: $("#upload-image-url-logo").val(),
                clickFn: function (url) {
                    editor.hideDialog();
                    var val = url;
                    if (url.toLowerCase().indexOf("http://") == -1 && url.toLowerCase().indexOf("https://") == -1) {
                        var filename = /images(.*)/.exec(url);
                        if (filename && filename[0]) {
                            val = filename[0];
                        }
                    }
                    $("#upload-image-url-logo-old").val($("#upload-image-url-logo").val());
                    $("#upload-image-url-logo").val(val);
                    $("#upload-image-preview-logo").html('<img src="' + url + '" width="80px;" />');
                }
            });
        });
    });
</script>
<script type="text/javascript">
    function check() {
        if ($.trim($('#title').val()) == '') {
            message('没有输入商家名称.', '', 'error');
            return false;
        }
        return true;
    }
</script>

<script type="text/javascript">
    kindeditor($('.richtext-clone'));
</script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>
<script type="text/javascript" src="http://api.map.baidu.com/getscript?v=1.4&ak=&services=&t=20140102035142"></script>
<script type="text/javascript">
    $(function () {
        $(".location").change(function () {
            bmap.searchMapByPCD();
        });
    });
    new PCAS("location_p", "location_c", "location_a", location_p, location_c, location_a);
    var bmap = {
        'option': {
            'lock': false,
            'container': 'l-map',
            'infoWindow': {'width': 250, 'height': 100, 'title': ''},
            'point': {'lng': "{if $reply['lng']!='0.0000000000' && !empty($reply['lng'])}{$reply['lng']}{else}116.735049{/if}", 'lat': "{if $reply['lat']!='0.0000000000' && !empty($reply['lat'])}{$reply['lat']}{else}23.367896{/if}"}
        },
        'init': function (option) {
            var $this = this;
            $this.option = $.extend({}, $this.option, option);

            $this.option.defaultPoint = new BMap.Point($this.option.point.lng, $this.option.point.lat);
            $this.bgeo = new BMap.Geocoder();
            $this.bmap = new BMap.Map($this.option.container);
            $this.bmap.centerAndZoom($this.option.defaultPoint, 15);
            $this.bmap.enableScrollWheelZoom();
            $this.bmap.enableDragging();
            $this.bmap.enableContinuousZoom();
            $this.bmap.addControl(new BMap.NavigationControl());
            $this.bmap.addControl(new BMap.OverviewMapControl());
            //添加标注
            $this.marker = new BMap.Marker($this.option.defaultPoint);
            $this.marker.setLabel(new BMap.Label('请您移动此标记，选择您的坐标！', {'offset': new BMap.Size(10, -20)}));
            $this.marker.enableDragging();
            $this.bmap.addOverlay($this.marker);
            //$this.marker.setAnimation(BMAP_ANIMATION_BOUNCE);
            $this.showPointValue($this.marker.getPosition());
            //拖动地图事件
            $this.bmap.addEventListener("dragging", function () {
                $this.setMarkerCenter();
                $this.option.lock = false;
            });
            //缩入地图事件
            $this.bmap.addEventListener("zoomend", function () {
                $this.setMarkerCenter();
                $this.option.lock = false;
            });
            //拖动标记事件
            $this.marker.addEventListener("dragend", function (e) {
                $this.showPointValue();
                $this.showAddress();
                $this.bmap.panTo(new BMap.Point(e.point.lng, e.point.lat));
                $this.option.lock = false;
                $this.marker.setAnimation(null);
            });
        },
        'searchMapByAddress': function (address) {
            var $this = this;
            $this.bgeo.getPoint(address, function (point) {
                if (point) {
                    $this.showPointValue();
                    $this.showAddress();
                    $this.bmap.panTo(point);
                    $this.setMarkerCenter();
                }
            });
        },
        'searchMapByPCD': function (address) {
            //alert($('#location_p').val()+$('#location_c').val()+$('#location_a').val());
            var $this = this;
            $this.option.lock = true;
            $this.searchMapByAddress($('#location_p').val() + $('#location_c').val() + $('#location_a').val());
        },
        'setMarkerCenter': function () {
            var $this = this;
            var center = $this.bmap.getCenter();
            $this.marker.setPosition(new BMap.Point(center.lng, center.lat));
            $this.showPointValue();
            $this.showAddress();
        },
        'showPointValue': function () {
            var $this = this;
            var point = $this.marker.getPosition();
            $('#lng').val(point.lng);
            $('#lat').val(point.lat);
        },
        'showAddress': function () {
            var $this = this;
            var point = $this.marker.getPosition();
            $this.bgeo.getLocation(point, function (s) {
                if (s) {
                    $('#place').val(s.address);
                    if (!$this.option.lock) {
                        //cascdeInit(s.addressComponents.province,s.addressComponents.city,s.addressComponents.district);
                        new PCAS("location_p", "location_c", "location_a", s.addressComponents.province, s.addressComponents.city, s.addressComponents.district);
                    }
                }
            });
        }
    };
    $(function () {
        var option = {};
        bmap.init(option);
    });
</script>
{template 'common/footer'}
