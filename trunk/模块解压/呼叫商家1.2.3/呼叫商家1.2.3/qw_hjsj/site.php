<?php 

defined('IN_IA') or exit('Access Denied'); include "Class/Weixin.class.php"; class Qw_hjsjModuleSite extends WeModuleSite { public $settings; private $appid; private $key; private $secret; private $mchid; public function __construct() { global $_W; $sql = 'SELECT `settings` FROM ' . tablename('uni_account_modules') . ' WHERE `uniacid` = :uniacid AND `module` = :module'; $settings = pdo_fetchcolumn($sql, array(':uniacid' => $_W['uniacid'], ':module' => 'qw_hjsj')); $settings = iunserializer($settings); $this -> settings = $settings; $this->appid = $_W['uniaccount']['key']; $this->key = $settings['api_secret']; $this->secret = $_W['uniaccount']['secret']; $this->mchid = $settings['merchant_id']; } public function doMobileindex(){ global $_W,$_GPC; $set = $this->settings; $jietime = $_SESSION['jietime']; $djinfo = str_replace("[dingjin]",$set['hjdj'],$set['djinfo']); $fxtitle = $set['fxtitle']; $fxdes = $set['fxdes']; $fxpic = tomedia($set['fxpic']); $uniacid = $_W['uniacid']; $openid = $_W['openid']; if ($_W['isajax']) { $fee = $_GPC['fee']; $hid = $_GPC['hid']; $year = date('Y', time()); $danhao = $year . time() . rand(1000, 2000); $data = array('fee' => $fee, 'uniacid' => $uniacid, 'ordersn' => $danhao, 'openid' => $openid, 'status' => 0, 'hid'=>$hid, 'xq' => '呼叫商家定金', 'title'=>'呼叫商家定金', 'addtime' => time(), 'dtransid'=>'' ); $rs = pdo_insert('qw_hjsj_djorder', $data); $orderxq = pdo_fetch("SELECT * FROM".tablename('qw_hjsj_djorder')."WHERE uniacid = '{$_W['uniacid']}' and ordersn='$danhao'"); $params = array('tid' => $orderxq['ordersn'], 'ordersn' => $danhao, 'title' => $orderxq['title'], 'user' => $openid, 'fee' => $fee, 'module' => 'qw_hjsj', 'virtual' => 1); $log = pdo_get('core_paylog', array('uniacid' => $_W['uniacid'], 'module' => $params['module'], 'tid' => $params['tid'])); if (empty($log)) { $log = array( 'uniacid' => $_W['uniacid'], 'acid' => $_W['acid'], 'openid' => $_W['member']['uid'], 'module' => $params['module'], 'tid' => $params['tid'], 'fee' => $params['fee'], 'card_fee' => $params['fee'], 'status' => '0', 'is_usecard' => '0', ); pdo_insert('core_paylog', $log); } $params = base64_encode(json_encode($params)); if ($rs) { exit(json_encode(array('error' => 1, 'message' => "已经成功进入微信支付", 'arr' => $data, 'params' => $params))); } else { exit(json_encode(array('error' => 0, 'message' => "请重试"))); } } $lastorder = pdo_fetch("SELECT * FROM".tablename('qw_hjsj_jilu')."WHERE uniacid = '$uniacid' and openid='$openid' order by addtime desc limit 1"); include $this->template('index'); } public function doMobilep_center(){ global $_W,$_GPC; $idd = $_GPC['idd']; $set = $this->settings; $openid = $_W['openid']; $uniacid = $_W['uniacid']; $sxq = $this->shangjiaxq(); $orderxq = $this->order($idd); $orderlist = pdo_fetchall("SELECT a.id,b.id as sid,a.truename,a.phone,a.gpsaddress,a.openid,a.status,a.paytype,a.paystatus,a.money,b.phone as sphone,b.openid as sopenid,b.name as sname,a.pjstatus,a.pjstar,b.picpath FROM ".tablename('qw_hjsj_jilu')."  as a left join ".tablename('qw_hjsj_shangjia'). " as b on a.sjid = b.id WHERE a.uniacid='$uniacid' and a.openid='$openid' order by a.addtime desc"); include $this->template('p_center'); } public function doMobilealert($message="成功",$warning="success"){ global $_W; include $this->template('alert'); die; } public function doMobilem_center(){ global $_W,$_GPC; $set=$this->settings; $uniacid = $_W['uniacid']; $openid = $_W['openid']; $sjxq = $this->shangjiaxq(); $sjid = $sjxq['id']; if(empty($sjxq)){ message("请先注册商家",$this->createMobileurl('m_joinin'),'error'); die; }else if($sjxq['status']!=1){ $message = "您的商家权限正在审核中"; $warning ="error"; $this->doMobilealert($message,$warning); die; }else{ } if($_W['isajax']){ if($_GPC['qxstatus']){ $idd = $_GPC['idd']; $quxiao = $_GPC['quxiao']; $hxq = $this->order($idd); if($hxq['status']!=1||$hxq['sjid']!=$sjid){ echo json_encode(array('error'=>-1,'message'=>'sorry,你没有权限')); } else{ pdo_update('qw_hjsj_jilu',array('status'=>2),array('id'=>$idd)); if($quxiao==1) { $data['truename'] = $hxq['truename']; $data['phone']=$hxq['phone']; $data['gpsaddress']=$hxq['gpsaddress']; $data['uploadsrc'] = $hxq['uploadsrc']; $data['localsrc'] = $hxq['localsrc']; $data['openid'] = $hxq['openid']; $data['uniacid'] = $hxq['uniacid']; $data['addtime'] = time(); $stime = date('Y-m-d H:i:s',$data['addtime']); $data['status'] = 0; $current = date('Y',time()).time(); $data['mp3path'] = $hxq['mp3path']; $data['ordersn'] = $current; $res = pdo_insert('qw_hjsj_jilu',$data); $newid = pdo_insertid(); $url = $this->createMobileurl('m_qiang',array('idd'=>$newid)); $host='http://'.$_SERVER['HTTP_HOST'].'/'; $url = str_replace('./',$host,$url); $tplid= $set['tplid']; $lefttpl = json_decode($set['lefttpl']); $righttpl = json_decode($set['righttpl']); $content=array(); foreach($lefttpl as $key=>$v){ $righttpl[$key]=str_replace('[sn]',$current,$righttpl[$key]); $righttpl[$key]=str_replace('[name]',$data['truename'],$righttpl[$key]); $righttpl[$key]=str_replace('[address]',$data['gpsaddress'],$righttpl[$key]); $righttpl[$key]=str_replace('[time]',$stime,$righttpl[$key]); $content[$v]= array('value'=>$righttpl[$key]); } $shanglist = pdo_fetchall("SELECT * FROM ".tablename('qw_hjsj_shangjia')." WHERE uniacid='$uniacid' and status=1"); foreach ($shanglist as $v){ if($v['openid']!=$openid) { $this->sendtpl($v['openid'],$url,$tplid,$content); } } } echo json_encode(array('error'=>1,'message'=>'成功'.$quxiao)); } die; } $idd = $_GPC['idd']; $order = pdo_fetch("SELECT a.id,b.id as sid,a.truename,a.phone,a.gpsaddress,a.openid,a.status,a.paystatus,a.paytype,a.money,a.ordersn,b.phone as sphone,b.openid as sopenid,a.pjstatus,a.pjstar FROM ".tablename('qw_hjsj_jilu')."  as a left join ".tablename('qw_hjsj_shangjia'). " as b on a.sjid = b.id  WHERE a.uniacid='$uniacid' and a.id='$idd' "); echo json_encode(array('error'=>1,'message'=>'成功','result'=>$order)); exit(); }else{ $orderlist = pdo_fetchall("SELECT a.id,b.id as sid,a.truename,a.phone,a.addtime,a.gpsaddress,a.openid,a.status,b.phone as sphone,b.openid as sopenid,d.avatar  FROM ".tablename('qw_hjsj_jilu')."  as a left join ".tablename('qw_hjsj_shangjia'). " as b on a.sjid = b.id  left join ".tablename('mc_mapping_fans')." as c on c.openid = a.openid left join ".tablename('mc_members')." as d on c.uid = d.uid WHERE a.uniacid='$uniacid' and b.id='$sjid' order by a.addtime desc"); include $this->template('m_center'); } } function shangjiaxq(){ global $_W; $uniacid = $_W['uniacid']; $openid = $_W['openid']; $xq = pdo_fetch("SELECT * FROM".tablename('qw_hjsj_shangjia')."WHERE uniacid ='$uniacid' and openid = '$openid'"); return $xq; } function order($idd){ global $_W; $uniacid = $_W['uniacid']; $orderxq = pdo_fetch("SELECT * FROM".tablename('qw_hjsj_jilu')."WHERE uniacid = '$uniacid' and id='$idd'" ); $openid = $orderxq['openid']; $touxiang = pdo_fetch("SELECT a.avatar FROM ".tablename('mc_members')." as a left join ".tablename('mc_mapping_fans')." as b on a.uid = b.uid WHERE a.uniacid = '$uniacid' and b.openid='$openid'"); $orderxq['avatar']=$touxiang['avatar']; return $orderxq; } public function doMobilem_joinin(){ global $_W,$_GPC; $openid = $_W['openid']; $uniacid = $_W['uniacid']; $xq = pdo_fetch("SELECT * FROM".tablename('qw_hjsj_shangjia')."WHERE uniacid = '$uniacid' and openid='$openid'"); if($_W['isajax']){ if($xq){ echo json_encode(array('error'=>-3,'message'=>'您已经注册过了')); exit(); } $sname = $_GPC['sname']; $jc = pdo_fetch("SELECT * FROM ".tablename('qw_hjsj_shangjia')." WHERE uniacid = '$uniacid' and name= '$sname' "); if(!empty($jc)){ echo json_encode(array('error'=>-3,'message'=>'名字不得重复')); exit(); } $sphone = $_GPC['sphone']; $saddress = $_GPC['saddress']; $mark = $_GPC['mark']; $loadsrc = $_GPC['loadsrc']; $data = array( 'openid'=>$openid, 'uniacid'=>$uniacid, 'name'=>$sname, 'phone'=>$sphone, 'address'=>$saddress, 'status'=>0, 'mark'=>$mark, 'addtime'=>time(), ); $file = "/addons/qw_hjsj/assets/images"; $picname = time().rand(100,200).".jpg"; $data['picpath'] = $this->getmedia($loadsrc,$file,$picname); $res = pdo_insert('qw_hjsj_shangjia',$data); if($res){ echo json_encode(array('error'=>1,'message'=>'成功')); exit(); }else{ echo json_encode(array('error'=>-1,'message'=>'失败')); exit(); } } if($xq){ message("您已经注册过商家了",$this->createMobileurl('m_center'),'success'); die; }else{ include $this->template('m_joinin'); } } public function doMobilem_qiang(){ global $_W,$_GPC; $idd = $_GPC['idd']; $openid = $_W['openid']; $uniacid = $_W['uniacid']; $sxq = $this->shangjiaxq(); $hxq = $this->order($idd); $set = $this->settings; if(empty($sxq)){ message("请先注册商家",$this->createMobileurl('m_joinin'),'error'); die; }else if($sxq['status']!=1){ $message = "正在审核中"; $warning ="error"; $this->doMobilealert($message,$warning); die; }else{ } if($hxq['status']>=1) { if(!empty($hxq['sjid'])&&$hxq['sjid']==$sxq['id']){ $qiang =1; }else{ $message="此单已被抢"; $warning = "error"; $this->doMobilealert($message,$warning); die; } } if($hxq['status']==4){ $message="此单已被退款"; $warning = "error"; $this->doMobilealert($message,$warning); die; } if($_W['isajax']){ $idd = $_GPC['idd']; $order = pdo_fetch("SELECT * FROM ".tablename('qw_hjsj_jilu'). " WHERE uniacid = '$uniacid' and id='$idd'"); if($order['status']>=1){ echo json_encode(array('error'=>-1,'message'=>'此单已经被抢')); exit(); }else{ $res = pdo_update('qw_hjsj_jilu',array('status'=>1,'sjid'=>$sxq['id']),array('id'=>$idd)); if($res){ $stime =date('Y-m-d H:i;s',time()); $url = $this->createMobileurl('p_center'); $host='http://'.$_SERVER['HTTP_HOST'].'/'; $url = str_replace('./',$host,$url); $tplid= $set['jiedantplid']; $lefttpl = json_decode($set['jiedanlefttpl']); $righttpl = json_decode($set['jiedanrighttpl']); $content=array(); foreach($lefttpl as $key=>$v){ $righttpl[$key]=str_replace('[sn]','暂无',$righttpl[$key]); $righttpl[$key]=str_replace('[name]',$sxq['name'],$righttpl[$key]); $righttpl[$key]=str_replace('[phone]',$sxq['phone'],$righttpl[$key]); $righttpl[$key]=str_replace('[time]',$stime,$righttpl[$key]); $content[$v]= array('value'=>$righttpl[$key]); } $this->sendtpl($order['openid'],$url,$tplid,$content); echo json_encode(array('error'=>1,'message'=>'抢单成功'.$sxq['id'],'result'=>$hxq)); exit(); }else{ echo json_encode(array('error'=>-1,'message'=>'失败'.$order['status'])); exit(); } } }else{ include $this->template('m_qiang'); } } public function doMobilep_pay(){ global $_W,$_GPC; $idd = $_GPC['idd']; $sid = $_GPC['sid']; $sxq = $this->shangjiaxq(); $uniacid = $_W['uniacid']; $orderxq= $this->order($idd); if(($orderxq['sjid']!=$sxq['id'])||($orderxq['paystatus']==1)||($sxq['status']!=1)) { $message = "此单已经处于结单或者商家权限不足!"; $warning ="error"; $this->doMobilealert($message,$warning); die; } if($_W['isajax']){ echo json_encode(array('error'=>1,'message'=>$idd."#".$sid."#")); exit(); }else{ include $this->template('p_pay'); } } public function doMobilejie(){ global $_W,$_GPC; $set = $this->settings; $openid = $_W['openid']; $uniacid = $_W['uniacid']; if($_W['isajax']){ $lastorder = pdo_fetch("SELECT * FROM".tablename('qw_hjsj_jilu')."WHERE uniacid = '$uniacid' and openid='$openid' order by addtime desc limit 1"); $data['truename'] = $truename = $_GPC['truename']; $data['phone']=$phone = $_GPC['phone']; $data['gpsaddress']=$gpsaddress = $_GPC['gpsaddress']; $data['uploadsrc'] = $uploadsrc = $_GPC['uploadsrc']; $data['localsrc'] = $_GPC['localsrc']; $data['openid'] = $_W['openid']; $data['uniacid'] = $_W['uniacid']; $data['addtime'] = time(); $stime = date('Y-m-d H:i:s',$data['addtime']); $data['status'] = 0; $current = date('Y',time()).time(); $file="/addons/qw_hjsj/mp3"; $mp3name = $current.".amr"; $mp3path = $this->getmedia($uploadsrc,$file,$mp3name); $data['mp3path'] = $mp3path; $data['ordersn'] = $current; $res = pdo_insert('qw_hjsj_jilu',$data); $newid = pdo_insertid(); if($res){ echo json_encode(array('error'=>1,'message'=>'chenggong','hid'=>$newid)); $_SESSION['jietime']= time(); exit(); }else{ echo json_encode(array('error'=>-1,'message'=>'shibai')); exit(); } } } function zfsucc($idd){ global $_W,$_GPC; $set = $this->settings; $uniacid = $_W['uniacid']; $hxq = $this->order($idd); $url = $this->createMobileurl('m_qiang',array('idd'=>$idd)); $host='http://'.$_SERVER['HTTP_HOST'].'/'; $url = str_replace('./',$host,$url); $tplid= $set['tplid']; $lefttpl = json_decode($set['lefttpl']); $righttpl = json_decode($set['righttpl']); $content=array(); $stime = date('Y-m-d H:i:s',$hxq['addtime']); foreach($lefttpl as $key=>$v){ $righttpl[$key]=str_replace('[sn]',$hxq['ordersn'],$righttpl[$key]); $righttpl[$key]=str_replace('[name]',$hxq['truename'],$righttpl[$key]); $righttpl[$key]=str_replace('[address]',$hxq['gpsaddress'],$righttpl[$key]); $righttpl[$key]=str_replace('[time]',$stime,$righttpl[$key]); $content[$v]= array('value'=>$righttpl[$key]); } $shanglist = pdo_fetchall("SELECT * FROM ".tablename('qw_hjsj_shangjia')." WHERE uniacid='$uniacid' and status=1"); foreach ($shanglist as $v){ $this->sendtpl($v['openid'],$url,$tplid,$content); } $message = "呼叫成功,等待商家联系"; $warning ="success"; $this->doMobilealert($message,$warning); die; } public function getmedia($media_id,$file,$picname){ $access_token = WeAccount::token(); $url = "http://file.api.weixin.qq.com/cgi-bin/media/get?access_token=".$access_token."&media_id=".$media_id; if (!file_exists($file)) { mkdir($file, 0777, true); } $targetName = '..'.$file.'/'.$picname; $ch = curl_init($url); $fp = fopen($targetName, 'wb'); curl_setopt($ch, CURLOPT_FILE, $fp); curl_setopt($ch, CURLOPT_HEADER, 0); curl_exec($ch); curl_close($ch); fclose($fp); return $file.'/'.$picname; } public function doWebshangjia(){ global $_W,$_GPC; $uniacid = $_W['uniacid']; $set = $this->settings; $con =""; $date = $_GPC['date']; $start = strtotime($date['start']); $end = strtotime($date['end'])+86399; if(empty($date)){ $start=time()-86400*20; $end=time()+86400*19+86399; } $con = " and addtime>='$start' and addtime<'$end' "; $status = $_GPC['status']; if (!empty($status)) { $con .= " and status = '$status' "; } $pindex = max(1, intval($_GPC['page'])); $psize = 20; $list = pdo_fetchall("SELECT * FROM ".tablename('qw_hjsj_shangjia')."WHERE uniacid='$uniacid' ".$con." order by addtime desc  LIMIT " . ($pindex - 1) * $psize . "," . $psize); $total = pdo_fetchall("SELECT * FROM ".tablename('qw_hjsj_shangjia')."WHERE uniacid='$uniacid' ".$con); $total = count($total); $pager = pagination($total, $pindex, $psize); if($_W['isajax']){ $idd = $_GPC['idd']; $cao = $_GPC['cao']; if($cao=='del'){ $re =pdo_delete("qw_hjsj_shangjia",array('id'=>$idd)); if($re){ echo exit(json_encode(array('error'=>1,'message'=>'删除成功'))); }else{ echo exit(json_encode(array('error'=>0,'message'=>'删除失败'))); } } $status = $_GPC['status']; $xq = pdo_fetch("SELECT * FROM ".tablename('qw_hjsj_shangjia')." WHERE uniacid='$uniacid' and id='$idd' and status='$status'"); $url=''; $tplid= $set['shenhetplid']; $lefttpl = json_decode($set['shenhelefttpl']); $righttpl = json_decode($set['shenherighttpl']); $content=array(); if(!$xq){ echo json_encode(array('error'=>-1,'message'=>'不存在该人员')); exit(); } if($status==1){ $res = pdo_update('qw_hjsj_shangjia',array('status'=>2),array('id'=>$idd,'status'=>1)); if($res){ $jieguo = "不通过"; $current = date('Y-m-d H:i:s',time()); foreach($lefttpl as $key=>$v){ $righttpl[$key]=str_replace('[time]',$current,$righttpl[$key]); $righttpl[$key]=str_replace('[jieguo]',$jieguo,$righttpl[$key]); $righttpl[$key]=str_replace('[name]',$xq['name'],$righttpl[$key]); $righttpl[$key]=str_replace('[phone]',$xq['phone'],$righttpl[$key]); $content[$v]= array('value'=>$righttpl[$key]); } $this->sendtpl($xq['openid'],$url,$tplid,$content); echo json_encode(array('error'=>1,'message'=>'修改成功')); exit(); }else{ echo json_encode(array('error'=>-1,'message'=>'修改失败')); exit(); } } if($status==2){ $res = pdo_update('qw_hjsj_shangjia',array('status'=>1),array('id'=>$idd,'status'=>2)); if($res){ $jieguo = "成功"; $current = date('Y-m-d H:i:s',time()); foreach($lefttpl as $key=>$v){ $righttpl[$key]=str_replace('[time]',$current,$righttpl[$key]); $righttpl[$key]=str_replace('[jieguo]',$jieguo,$righttpl[$key]); $righttpl[$key]=str_replace('[name]',$xq['name'],$righttpl[$key]); $righttpl[$key]=str_replace('[phone]',$xq['phone'],$righttpl[$key]); $content[$v]= array('value'=>$righttpl[$key]); } $this->sendtpl($xq['openid'],$url,$tplid,$content); echo json_encode(array('error'=>1,'message'=>'修改成功')); exit(); }else{ echo json_encode(array('error'=>-1,'message'=>'修改失败')); exit(); } } if($status==0){ $res = pdo_update('qw_hjsj_shangjia',array('status'=>1),array('id'=>$idd)); if($res){ $jieguo = "成功"; $current = date('Y-m-d H:i:s',time()); foreach($lefttpl as $key=>$v){ $righttpl[$key]=str_replace('[time]',$current,$righttpl[$key]); $righttpl[$key]=str_replace('[jieguo]',$jieguo,$righttpl[$key]); $righttpl[$key]=str_replace('[name]',$xq['name'],$righttpl[$key]); $righttpl[$key]=str_replace('[phone]',$xq['phone'],$righttpl[$key]); $content[$v]= array('value'=>$righttpl[$key]); } $this->sendtpl($xq['openid'],$url,$tplid,$content); echo json_encode(array('error'=>1,'message'=>'修改成功')); exit(); }else{ echo json_encode(array('error'=>-1,'message'=>'修改失败')); exit(); } } }else{ include $this->template('shangjia'); } } public function doWeborder(){ global $_W,$_GPC; $uniacid = $_W['uniacid']; $con =""; $date = $_GPC['date']; $start = strtotime($date['start']); $end = strtotime($date['end'])+86399; if(empty($date)){ $start=time()-86400*20; $end=time()+86400*19+86399; } $con = " and a.addtime>='$start' and a.addtime<'$end' "; $status = $_GPC['status']; if (!empty($status)) { $con .= " and a.status = '$status' "; } if($status==0){ $con .= " and a.status = 0 "; } $pindex = max(1, intval($_GPC['page'])); $psize = 20; $list = pdo_fetchall("SELECT a.truename,a.phone,a.gpsaddress,a.addtime,a.status,a.ordersn,a.paystatus,a.money,a.paystatus,b.name as sname,b.phone as sphone,b.address as saddress,a.paytype,a.pjstatus,a.pjstar,c.dtransid FROM ".tablename('qw_hjsj_jilu')." as a left join ".tablename('qw_hjsj_shangjia')." as b on a.sjid=b.id left join ".tablename("qw_hjsj_djorder")." as c on a.id= c.hid  WHERE a.uniacid='$uniacid' ".$con." order by a.addtime desc  LIMIT " . ($pindex - 1) * $psize . "," . $psize); $total = pdo_fetchall("SELECT * FROM ".tablename('qw_hjsj_jilu')." as a left join ". tablename('qw_hjsj_shangjia')." as b on a.sjid = b.id WHERE a.uniacid='$uniacid' ".$con); $total = count($total); $pager = pagination($total, $pindex, $psize); include $this->template('order'); } public function p($arr){ echo "<pre>"; print_r($arr); } public function doMobileceshiyin(){ global $_W,$_GPC; $openid = $_W['openid']; $uniacid = $_W['uniacid']; $info = pdo_fetch("SELECT a.avatar FROM ".tablename('mc_members')." as a left join ".tablename('mc_mapping_fans')." as b on a.uid = b.uid WHERE a.uniacid ='$uniacid' and b.openid='$openid'"); $avatar = $info['avatar']; echo "<img src='$avatar' style='width:100px;height:100px'>"; } public function sendtpl($openid, $url, $template_id, $content) { global $_GPC, $_W; load() -> classs('weixin.account'); load() -> func('communication'); $obj = new WeiXinAccount(); $access_token = $obj -> fetch_available_token(); $data = array( 'touser' => $openid, 'template_id' => $template_id, 'url' => $url, 'topcolor' => "#FF0000", 'data' => $content, ); $json = json_encode($data); $url = 'https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=' . $access_token; $ret = ihttp_post($url, $json); } public function sendtext($text,$openid){ global $_GPC, $_W; load() -> func('tpl'); load() -> model('mc'); $acc = WeAccount::create($_W['account']['acid']); $send = array("touser" =>$openid, "msgtype" => "text", "text" => array("content" => urlencode($text))); $res = $acc -> sendCustomNotice($send); } public function doMobilepay(){ global $_W,$_GPC; $idd = $_GPC['idd']; $sid = $_GPC['sid']; $money = $_GPC['money']; $openid = $_W['openid']; $uniacid = $_W['uniacid']; $orderxq = pdo_fetch("SELECT * FROM ".tablename('qw_hjsj_jilu')."WHERE uniacid ='$uniacid' and id='$idd'"); if($orderxq['paystatus']==1){ $message = "此订单已经支付成功"; $warning ="success"; $this->doMobilealert($message,$warning); die; } pdo_update("qw_hjsj_jilu",array('money'=>$money),array('id'=>$idd)); $params = array( 'tid' => $orderxq['ordersn'], 'ordersn' => $orderxq['ordersn'], 'title' => '呼叫订单支付', 'fee' => $money, 'user' => $_W['member']['uid'], ); include $this->template('pay'); } public function doMobilecash(){ global $_W,$_GPC; $set = $this->settings; if($_W['isajax']){ $idd = $_GPC['idd']; $sid = $_GPC['sid']; $money = $_GPC['money']; $uniacid = $_W['uniacid']; $hxq = $this->order($idd); $sxq = pdo_fetch("SELECT * FROM".tablename('qw_hjsj_shangjia')."WHERE uniacid='$uniacid' and id='$sid'"); if($hxq['paystatus']==1){ echo json_encode(array('error'=>-1,'message'=>"此订单已经支付")); die; } $data = array( 'paytype'=>5, 'paystatus'=>1, 'money'=>$money, 'status'=>3, ); $sdata= array( 'cash'=>$money+$sxq['cash'], ); $r =pdo_update('qw_hjsj_jilu',$data,array('uniacid'=>$uniacid,'id'=>$idd,'sjid'=>$sid)); $sr = pdo_update('qw_hjsj_shangjia',$sdata,array('uniacid'=>$uniacid,'id'=>$sid)); $mdata = array( 'hid'=>$idd, 'cash'=>$money, 'sid'=>$sid, 'status'=>1, 'uniacid'=>$uniacid, 'addtime'=>time(), ); pdo_insert('qw_hjsj_money',$mdata); if($r&$sr){ $purl = $this->createMobileurl('p_center'); $surl = $this->createMobileurl('m_center'); $host='http://'.$_SERVER['HTTP_HOST'].'/'; $purl = str_replace('./',$host,$purl); $surl = str_replace('./',$host,$surl); $tplid= $set['succtplid']; $lefttpl = json_decode($set['succlefttpl']); $righttpl = json_decode($set['succrighttpl']); $current = date('Y-m-d H:i:s',time()); $sname = $sxq['name']; $name = $hxq['truename']; $paytype = "现金"; $xnyongjin=0; foreach($lefttpl as $key=>$v){ $righttpl[$key]=str_replace('[time]',$current,$righttpl[$key]); $righttpl[$key]=str_replace('[sname]',$sname,$righttpl[$key]); $righttpl[$key]=str_replace('[name]',$name,$righttpl[$key]); $righttpl[$key]=str_replace('[money]',$money,$righttpl[$key]); $righttpl[$key]=str_replace('[paytype]',$paytype,$righttpl[$key]); $righttpl[$key]=str_replace('[wxyj]',$xnyongjin,$righttpl[$key]); $content[$v]= array('value'=>$righttpl[$key]); } $this->sendtpl($hxq['openid'],$purl,$tplid,$content); $this->sendtpl($sxq['openid'],$surl,$tplid,$content); echo json_encode(array('error'=>1,'message'=>"现金支付成功")); exit(); }else{ echo json_encode(array('error'=>-1,'message'=>"支付失败")); exit(); } } } public function payResult($params) { global $_W; $set = $this->settings; $openid = $_W['openid']; $uniacid = $_W['uniacid']; $paytype = array('credit' => '1', 'wechat' => '2', 'alipay' => '3', 'delivery' => '4'); $data['paytype'] = $paytype[$params['type']]; if ($paytype[$params['type']] == '') { $data['paytype'] = 6; } if ($params['type'] == 'wechat') { $data['transid'] = $params['tag']['transaction_id']; } $ordersn = $params['tid']; if(strlen($ordersn)>14){ $orderxq = pdo_fetch("SELECT * FROM ".tablename('qw_hjsj_djorder')." WHERE uniacid='$uniacid' and ordersn = '$ordersn'"); pdo_update("qw_hjsj_djorder",array("status"=>1,"dtransid"=>$data['transid']),array('ordersn'=>$ordersn)); $idd = $orderxq['hid']; $this->zfsucc($idd); die; }else{ $hxq = pdo_fetch("SELECT * FROM ".tablename('qw_hjsj_jilu')."WHERE uniacid = '$uniacid' and ordersn='$ordersn'"); $sid = $hxq['sjid']; $sxq = pdo_fetch("SELECT * FROM".tablename('qw_hjsj_shangjia')."WHERE uniacid='$uniacid' and id='$sid'"); if($hxq['paystatus']==1){ $message = "此订单已经支付成功"; $warning ="success"; $this->doMobilealert($message,$warning); die; } if ($params['from'] == 'return') { if ($params['result'] == 'success') { $data['paystatus']=1; $data['status']=3; pdo_update('qw_hjsj_jilu',$data,array('uniacid'=>$uniacid,'ordersn'=>$ordersn)); $sdata= array( 'xncash'=>$sxq['xncash']+$params['fee'], 'money'=>$this->yongjin($params['fee'])+$sxq['money'], ); $xnyongjin = $this->yongjin($params['fee']); pdo_update('qw_hjsj_shangjia',$sdata,array('uniacid'=>$uniacid,'id'=>$sid)); $mdata= array( 'xncash'=>$params['fee'], 'sid'=>$sid, 'hid'=>$hxq['id'], 'status'=>1, 'uniacid'=>$uniacid, 'addtime'=>time(), 'jsstatus'=>1, ); pdo_insert('qw_hjsj_money',$mdata); $purl = $this->createMobileurl('p_center'); $surl = $this->createMobileurl('m_center'); $host='http://'.$_SERVER['HTTP_HOST'].'/'; $purl = str_replace('./',$host,$purl); $surl = str_replace('./',$host,$surl); $tplid= $set['succtplid']; $lefttpl = json_decode($set['succlefttpl']); $righttpl = json_decode($set['succrighttpl']); $current = date('Y-m-d H:i:s',time()); $sname = $sxq['name']; $name = $hxq['truename']; switch ($hxq['paytype']){ case 1:$paytype="余额支付";break; case 2:$paytype="微信支付";break; case 3:$paytype="支付支付";break; case 4:$paytype="优惠券支付";break; default:$paytype="微信支付";break; } foreach($lefttpl as $key=>$v){ $righttpl[$key]=str_replace('[time]',$current,$righttpl[$key]); $righttpl[$key]=str_replace('[sname]',$sname,$righttpl[$key]); $righttpl[$key]=str_replace('[name]',$name,$righttpl[$key]); $righttpl[$key]=str_replace('[money]',$hxq['money'],$righttpl[$key]); $righttpl[$key]=str_replace('[paytype]',$paytype,$righttpl[$key]); $righttpl[$key]=str_replace('[wxyj]',$xnyongjin,$righttpl[$key]); $content[$v]= array('value'=>$righttpl[$key]); } $this->sendtpl($hxq['openid'],$purl,$tplid,$content); $this->sendtpl($sxq['openid'],$surl,$tplid,$content); $message = "支付成功"; $warning ="success"; $this->doMobilealert($message,$warning); } else { $message = "支付失败"; $warning ="error"; $this->doMobilealert($message,$warning); } } } } public function doMobilepingjia(){ global $_W,$_GPC; $idd = $_GPC['idd']; $star = $_GPC['star']; $uniacid = $_W['uniacid']; if($_W['isajax']){ $hxq = $this->order($idd); if($hxq['status']!=3){ echo json_encode(array('error'=>-1,'message'=>'不满足条件')); exit(); } $res = pdo_update('qw_hjsj_jilu',array('pjstatus'=>1,'pjstar'=>$star),array('id'=>$idd,'uniacid'=>$uniacid)); if($res) { echo json_encode(array('error'=>1,'message'=>'评价成功')); exit(); }else{ echo json_encode(array('error'=>-1,'message'=>'失败')); exit(); } } } private function refund($transaction_id,$out_refund_no,$total,$refund_fee,$isreturn = false){ global $_W, $_GPC; load()->func('communication'); $appid = $this->appid; $key = $this->key; $mchid = $this->mchid; $url = "https://api.mch.weixin.qq.com/secapi/pay/refund"; $pars = array(); $pars['appid'] = $appid; $pars['mch_id'] =$mchid; $pars['nonce_str'] = random(32); $pars['transaction_id'] = $transaction_id; $pars['out_refund_no'] = $out_refund_no; $pars['total_fee'] = $total; $pars['refund_fee'] =$refund_fee; $pars['op_user_id'] = $mchid; ksort($pars,SORT_STRING); $string1 = ''; foreach ($pars as $k => $v) { $string1 .= "{$k}={$v}&"; } $string1 .= "key={$key}"; $pars['sign'] = strtoupper(md5($string1)); $xml = array2xml($pars); $extras = array(); $extras['CURLOPT_CAINFO'] = MODULE_ROOT . '/cert/rootca.pem.' . $_W['uniacid']; $extras['CURLOPT_SSLCERT'] = MODULE_ROOT . '/cert/apiclient_cert.pem.' . $_W['uniacid']; $extras['CURLOPT_SSLKEY'] = MODULE_ROOT . '/cert/apiclient_key.pem.' . $_W['uniacid']; $procResult = null; $resp = ihttp_request($url, $xml, $extras); if (is_error($resp)) { $procResult = $resp; } else { $xml = '<?xml version="1.0" encoding="utf-8"?>' . $resp['content']; $dom = new DOMDocument(); if ($dom->loadXML($xml)) { $xpath = new DOMXPath($dom); $code = $xpath->evaluate('string(//xml/return_code)'); $ret = $xpath->evaluate('string(//xml/result_code)'); if (strtolower($code) == 'success' && strtolower($ret) == 'success') { $procResult = error(1,'success'); } else { $error = $xpath->evaluate('string(//xml/err_code_des)'); $code = $xpath->evaluate('string(//xml/err_code)'); $procResult = error(-2, array('code' => $code, 'error' => $error)); } } else { $procResult = error(-1, 'error response'); } } if (is_error($procResult)) { $this->fr_log($procResult['message']); } return $procResult; } private function tx($partner_trade_no,$openid,$amount,$des){ global $_W,$_GPC; $appid = $this->appid; $key = $this->key; $mchid = $this->mchid; load()->func('communication'); $url = "https://api.mch.weixin.qq.com/mmpaymkttransfers/promotion/transfers"; $pars = array(); $pars['mch_appid'] = $appid; $pars['mchid'] = $mchid; $pars['nonce_str']= random(32); $pars['partner_trade_no']=$partner_trade_no; $pars['openid']=$openid; $pars['check_name']= 'NO_CHECK'; $pars['amount']=$amount; $pars['desc']=$des; $pars['spbill_create_ip']='127.0.0.1'; ksort($pars,SORT_STRING); $string1 = ''; foreach ($pars as $k => $v) { $string1 .= "{$k}={$v}&"; } $string1 .= "key={$key}"; $pars['sign'] = strtoupper(md5($string1)); $xml = array2xml($pars); $extras = array(); $extras['CURLOPT_CAINFO'] = MODULE_ROOT . '/cert/rootca.pem.' . $_W['uniacid']; $extras['CURLOPT_SSLCERT'] = MODULE_ROOT . '/cert/apiclient_cert.pem.' . $_W['uniacid']; $extras['CURLOPT_SSLKEY'] = MODULE_ROOT . '/cert/apiclient_key.pem.' . $_W['uniacid']; $procResult = null; $resp = ihttp_request($url, $xml, $extras); if (is_error($resp)) { $procResult = $resp; } else { $xml = '<?xml version="1.0" encoding="utf-8"?>' . $resp['content']; $dom = new DOMDocument(); if ($dom->loadXML($xml)) { $xpath = new DOMXPath($dom); $code = $xpath->evaluate('string(//xml/return_code)'); $ret = $xpath->evaluate('string(//xml/result_code)'); if (strtolower($code) == 'success' && strtolower($ret) == 'success') { $procResult = error(1,'success'); } else { $error = $xpath->evaluate('string(//xml/err_code_des)'); $code = $xpath->evaluate('string(//xml/err_code)'); $procResult = error(-2, array('code' => $code, 'error' => $error)); } } else { $procResult = error(-1, 'error response'); } } if (is_error($procResult)) { $this->fr_log($procResult['message']); } return $procResult; } public function doMobileceshi(){ global $_W,$_GPC; $openid = $_W['openid']; $uniacid = $_W['uniacid']; $ttime = time(); $this->tuikuan($ttime); } private function tuikuan($ttime){ global $_W,$_GPC; $openid = $_W['openid']; $uniacid = $_W['uniacid']; $tklist = pdo_fetchall("SELECT a.*,b.dtransid,b.fee,b.ordersn as dordersn FROM ".tablename("qw_hjsj_jilu")." as a left join ".tablename("qw_hjsj_djorder")." as b on a.id = b.hid WHERE a.uniacid = '$uniacid'  and a.status=0 and a.addtime<$ttime order by a.addtime desc "); foreach ($tklist as $v){ $fee = intval($v['fee']*100); if($fee>0){ $res =$this->refund($v['dtransid'],$v['dtransid'],$fee,$fee); echo 12; } } } function yongjin($fee){ $set = $this->settings; $bl=$set['yjbl']*0.01; $fee = round($bl*$fee,2); return $fee; } public function doWebmoney(){ global $_W,$_GPC; $op = trim($_GPC['op'])?trim($_GPC['op']):'display'; $con=""; $moneylist = pdo_fetchall("SELECT a.id as mid,a.hid,a.sid,a.cash,a.xncash,a.addtime as maddtime,c.* FROM ".tablename('qw_hjsj_money')." as a left join ".tablename('qw_hjsj_jilu')." as b on a.hid = b.id left join ".tablename('qw_hjsj_shangjia')." as c on a.sid = c.id"); include $this->template('money'); } public function doWebcash(){ global $_W,$_GPC; $set = $this->settings; $uniacid = $_W['uniacid']; $op = trim($_GPC['op'])?trim($_GPC['op']):'display'; $shangjialist = pdo_fetchall("SELECT id,name FROM".tablename('qw_hjsj_shangjia')."WHERE uniacid='$uniacid' and status=1"); $con=""; $date = $_GPC['date']; $start = strtotime($date['start']); $end = strtotime($date['end'])+86399; if(empty($date)){ $start=time()-86400*20; $end=time()+86400*19+86399; } if($_GPC['select1']!=0){ $select1 = $_GPC['select1']; $con.=" and c.id = '$select1' "; } if($_GPC['jsstatus']!=''){ $jsstatus = $_GPC['jsstatus']; $con.=" and a.jsstatus = '$jsstatus'"; } $con .= " and b.addtime>='$start' and b.addtime<'$end' "; if($_W['isajax']){ $idd= $_GPC['idd']; if(is_array($idd)){ $string = implode(',',$idd); $mlist = pdo_fetchall("SELECT * FROM ".tablename('qw_hjsj_money')." WHERE uniacid = '$uniacid' and id in ('$string')"); foreach($mlist as $v){ if($v['jsstatus']==1){ }else{ $sid = $v['sid']; $sxq = pdo_fetch("SELECT openid,money FROM ".tablename('qw_hjsj_shangjia')."WHERE uniacid = '$uniacid' and id='$sid'"); $sdata = array( 'money'=>$this->yongjin($v['cash'])+$sxq['money'], ); $res = pdo_update('qw_hjsj_shangjia',$sdata,array('id'=>$v['sid'])); $r = pdo_update('qw_hjsj_money',array('jsstatus'=>1,'addtime'=>time()),array('id'=>$idd)); } } echo exit(json_encode(array('error'=>1,'message'=>'结算成功'))); } else{ $moneyorder = pdo_fetch("SELECT * FROM".tablename('qw_hjsj_money')."WHERE uniacid= '$uniacid' and id='$idd'"); $jsstatus = $moneyorder['jsstatus']; if($jsstatus==1){ echo exit(json_encode(array('error'=>-1,'message'=>"此订单已经结算"))); }else{ $sid = $moneyorder['sid']; $sxq = pdo_fetch("SELECT openid,money FROM ".tablename('qw_hjsj_shangjia')."WHERE uniacid = '$uniacid' and id='$sid'"); $sdata = array( 'money'=>$this->yongjin($moneyorder['cash'])+$sxq['money'], ); $cashyj = $this->yongjin($moneyorder['cash']); $res = pdo_update('qw_hjsj_shangjia',$sdata,array('id'=>$moneyorder['sid'])); $r = pdo_update('qw_hjsj_money',array('jsstatus'=>1,'addtime'=>time()),array('id'=>$idd)); $jiesuantime = date('Y-m-d H:i:s',time()); $hid = $moneyorder['hid']; $hxq = pdo_fetch("SELECT *  FROM ".tablename('qw_hjsj_jilu')."WHERE uniacid = '$uniacid' and id='$hid'"); if($res&&$r){ $url=""; $content = array( 'first'=>array( 'value'=>'您好，此订单结算成功。' ), 'keyword1'=>array( 'value'=>$hxq['ordersn'], ), 'keyword2'=>array( 'value'=>$cashyj, ), 'keyword3'=>array( 'value'=>date('Y-m-d H:i:s',time()), ), 'remark'=>array( 'value'=>'谢谢您的使用。' ) ); $this->sendtpl($sxq['openid'],$url,$set['jssuccid'],$content); echo exit(json_encode(array('error'=>1,'message'=>"此订单结算成功",'jiesuantime'=>$jiesuantime))); }else{ echo exit(json_encode(array('error'=>-1,'message'=>"此订单结算失败"))); } } } exit(); } $pindex = max(1, intval($_GPC['page'])); $psize = 10; $moneylist = pdo_fetchall("SELECT a.id as mid,a.hid,a.sid,a.cash as mcash,a.xncash,a.addtime as maddtime,a.jsstatus,c.*,b.* FROM ".tablename('qw_hjsj_money')." as a left join ".tablename('qw_hjsj_jilu')." as b on a.hid = b.id left join ".tablename('qw_hjsj_shangjia')." as c on a.sid = c.id WHERE a.id>0 and a.opid=1 ".$con." order by b.addtime desc LIMIT ".($pindex-1)*$psize."," .$psize); $total = pdo_fetchall("SELECT a.id as mid,a.hid,a.sid,a.cash,a.xncash,a.addtime as maddtime,a.jsstatus,c.*,b.* FROM ".tablename('qw_hjsj_money')." as a left join ".tablename('qw_hjsj_jilu')." as b on a.hid = b.id left join ".tablename('qw_hjsj_shangjia')." as c on a.sid = c.id WHERE a.id>0 and a.opid=1 ".$con); $total = count($total); $pager = pagination($total, $pindex, $psize); include $this->template('cash'); } public function doWebtixian(){ global $_W,$_GPC; $set = $this->settings; $uniacid = $_W['uniacid']; $shangjialist = pdo_fetchall("SELECT id,name FROM".tablename('qw_hjsj_shangjia')."WHERE uniacid='$uniacid' and status=1"); $con=""; $date = $_GPC['date']; $start = strtotime($date['start']); $end = strtotime($date['end'])+86399; if(empty($date)){ $start=time()-86400*20; $end=time()+86400*19+86399; } if($_GPC['select1']!=0){ $select1 = $_GPC['select1']; $con.=" and b.id = '$select1' "; } $txstatus = $_GPC['txstatus']; if($txstatus){ $con.=" and a.txstatus = '$txstatus' "; } $con .= " and b.addtime>='$start' and b.addtime<'$end' "; if($_W['isajax']){ $idd = $_GPC['idd']; $txorder = $_GPC['txorder']; $morder = pdo_fetch("SELECT * FROM ".tablename('qw_hjsj_money')."WHERE uniacid ='$uniacid' and opid=2 and id='$idd'"); if($morder['txstatus']==1){ echo exit(json_encode(array('error'=>-1,'message'=>'已经提现'))); } $fee = $morder['txmoney']*100; $sid = $morder['sid']; $sxq=pdo_fetch("SELECT * FROM ".tablename('qw_hjsj_shangjia')." WHERE uniacid='$uniacid' and id= '$sid'"); $des = $sxq['name']."提现"; $res = $this->tx($txorder,$sxq['openid'],$fee,$des); if($res['errno']==1){ $r = pdo_update("qw_hjsj_money",array('txstatus'=>1),array('id'=>$idd)); $data['dmoney'] =$sxq['dmoney']-$morder['txmoney']; $rr = pdo_update("qw_hjsj_shangjia",$data,array('id'=>$sid)); if($r&&$rr){ $url=""; $content = array( 'first'=>array( 'value'=>'微信提现到账' ), 'money'=>array( 'value'=>$morder['txmoney'] ), 'timet'=>array( 'value'=>date('Y-m-d H:i:s',time()), ), 'remark'=>array( 'value'=>'谢谢您的使用。' ) ); $this->sendtpl($sxq['openid'],$url,$set['txsuccid'],$content); echo exit(json_encode(array('error'=>1,'message'=>'已经提现','res'=>$res))); }else{ echo exit(json_encode(array('error'=>-1,'message'=>'提现失败','res'=>$res))); } }else{ echo exit(json_encode(array('error'=>-1,'message'=>'提现失败','res'=>$res))); } } $pindex = max(1, intval($_GPC['page'])); $psize = 20; $txlist = pdo_fetchall("SELECT a.*,b.openid,b.name FROM ".tablename('qw_hjsj_money')." as a left join ".tablename('qw_hjsj_shangjia')." as b on a.sid = b.id WHERE a.uniacid='$uniacid' and a.opid=2 ".$con." order by a.addtime desc LIMIT ".($pindex-1)*$psize.",".$psize); $total = pdo_fetchall("SELECT a.*,b.openid,b.name FROM ".tablename('qw_hjsj_money')." as a left join ".tablename('qw_hjsj_shangjia')." as b on a.sid = b.id WHERE a.uniacid='$uniacid' and a.opid=2 ".$con); $total = count($total); $pager = pagination($total, $pindex, $psize); include $this->template('tixian'); } public function doMobilem_wallet(){ global $_W,$_GPC; $set = $this->settings; $xianzhi = $set['txxz']; $uniacid = $_W['uniacid']; $openid = $_W['openid']; $sxq = $this->shangjiaxq(); if($_W['isajax']){ $sid = $_GPC['sid']; $txmoney = $_GPC['txmoney']; $data = array( 'uniacid'=>$uniacid, 'sid'=>$sid, 'txmoney'=>$txmoney, 'addtime'=>time(), 'txorder'=>time().rand(1000,2000), 'txstatus'=>0, 'opid'=>2, ); $sdata = array( 'money'=>$sxq['money']-$txmoney, 'dmoney'=>$sxq['dmoney']+$txmoney, ); $r = pdo_update('qw_hjsj_shangjia',$sdata,array('id'=>$sid)); $res = pdo_insert('qw_hjsj_money',$data); $data['addtime'] = date('Y-m-d H:i:s',time()); if($r&&$res){ $url=""; $content = array( 'first'=>array( 'value'=>'提现申请已提交，等待后台审核。' ), 'money'=>array( 'value'=>$txmoney ), 'timet'=>array( 'value'=>$data['addtime'], ), 'remark'=>array( 'value'=>'谢谢您的使用。' ) ); $this->sendtpl($sxq['openid'],$url,$set['txtjid'],$content); echo exit(json_encode(array('error'=>1,'message'=>'提交成功','res'=>$data,'yue'=>$sdata['money']))); }else{ echo exit(json_encode(array('error'=>0,'message'=>'提交失败'))); } } $sid = $sxq['id']; $pindex = max(1, intval($_GPC['page'])); $psize = 20; $txlist = pdo_fetchall("SELECT * FROM ".tablename('qw_hjsj_money')." WHERE uniacid='$uniacid' and sid='$sid' and opid=2 order by addtime desc "); $total = pdo_fetchall("SELECT * FROM ".tablename('qw_hjsj_money')." WHERE uniacid='$uniacid' and sid='$sid' and opid=2"); $total = count($total); $pager = pagination($total, $pindex, $psize); include $this->template('m_wallet'); } public function doMobilem_record(){ global $_W,$_GPC; $uniacid = $_W['uniacid']; $starttime = $_GPC['starttime']; $endtime = $_GPC['endtime']; $con=""; if($starttime && $endtime){ $starttime1 = strtotime($starttime); $endtime1 = strtotime($endtime); $con .= " and addtime>'$starttime1' and addtime<'$endtime1' "; } $openid = $_W['openid']; $sxq = $this->shangjiaxq(); $sid = $sxq['id']; $liushui=$_GPC['liushui']?$_GPC['liushui']:'cash'; if($liushui=='cash'){ $sum = pdo_fetchall("SELECT SUM(cash) as cashsum FROM ".tablename('qw_hjsj_money')." WHERE uniacid='$uniacid' and cash>0 and sid= '$sid' and opid=1".$con); $moneylist = pdo_fetchall("SELECT * FROM ".tablename('qw_hjsj_money')." WHERE uniacid='$uniacid' and cash>0 and sid= '$sid' and opid=1".$con); }else{ $sum = pdo_fetchall("SELECT SUM(xncash) as cashsum FROM ".tablename('qw_hjsj_money')." WHERE uniacid='$uniacid' and xncash>0 and sid= '$sid' and opid=1".$con); $moneylist = pdo_fetchall("SELECT * FROM ".tablename('qw_hjsj_money')." WHERE uniacid='$uniacid' and xncash>0 and sid= '$sid' and opid=1".$con); } if($sum[0][cashsum]==0){ $sum=0; } include $this->template('m_record'); } }

?>