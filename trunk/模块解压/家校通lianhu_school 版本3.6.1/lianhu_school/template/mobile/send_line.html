<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="telephone=no">
    <title>发布消息-{$class_name}-{$_SESSION['school_name']}</title>
    {template 'common'}
    <link rel="stylesheet" href="{MODULE_URL}style/css/buttons.css">
    <link rel="stylesheet" href="{MODULE_URL}style/css/app.min.css">
    <link rel="stylesheet" href="{MODULE_URL}style/css/style_nav.css">
    <link rel="stylesheet" href="{MODULE_URL}style/css/line_css.css">
    <link href="http://cdn.bootcss.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
     <script src="{MODULE_URL}style/js/modernizr.js"></script>
     <script src="{MODULE_URL}style/js/jquery.lazyload.js?v=1.9.1"></script>
     <script src="{MODULE_URL}style/js/main.js"></script>
     </head>
     <body   style='background:#fff'  >
<div class="top-wrap">
	<div class="fn-clear tr-box top" >
       <div class='text_center fn-text-center'>发布消息</div>
     </div>
 </div>
    <form enctype="multipart/form-data" id="new_article" method="post" class="post-form" > 
        <div class='form-group' style='margin-bottom:10px;'>
        <textarea id="addtext" name="content" maxlength="1000" rows="5" placeholder="分享一件新鲜事..." required=""></textarea>
        </div>
        <div class='form-group' style='margin-bottom:5px;'>
            <div id='img_list' style='margin-bottom:5px;'>
                <div class='clear'></div>
            </div>
            <div  class='hide' id='img_value'>
                
            </div>
            <div class='clear'></div>
         </div>
        <div class='form-group'>
             <div class="button button-primary button-rounded button-small" style='margin-bottom:5px;margin-left:10px;' id="chooseImage">选择照片</div>
             <div id='uploadImg' class="button button-highlight button-rounded button-small" style='margin-bottom:5px;margin-left:10px;'onclick="uploadImg()">上传</div>
         </div>
        <div class="article_sub" style='margin-bottom:20px;'>
            <button type="submit" class="add-article">发送</button>
        </div>
    </form>
</body>
{template 'jsweixin'}
<script>
    $(function(){
       $(".help-block").hide();
       $('input[name="image"]').css('width',"80%"); 
       $('input[name="image"]').css('display','inline-block');
       $('input[name="image"]').css('margin-left','5%');
       $('input[name="image"]').css('margin-right','5%');
       $("button[type='button']").css('display','inline-block');
       $("button[type='button']").css('margin-right','5%');
    });
</script>
<script>
 var images = {
    localId: [],
    serverId: []
  };
  document.querySelector('#chooseImage').onclick = function () {
    images.localId='';
    $('#img_list').html('');
    wx.chooseImage({
      success: function (res) {
        images.localId = res.localIds;
        $.each(images.localId,function(i,e){
            insertImg(e);
        });
          $("#uploadImg").html("上传");
          uploadImg();
      }
    });
  };
function insertImg(img_src){
    $('#img_list').prepend("<div style='background-size:cover; background-image:url("+img_src+");width:23%; height:100px;float:left;margin-left:2%;overflow: hidden; margin-bottom:5px;'></div>");
}
function insertValue(value){
    $("#img_value").prepend("<input type='hidden' name='img_value[]' value='"+value+"' >");
}
function uploadImg(){
      $("#img_value").html('');
     if (images.localId.length == 0) {
        alert('请先选择图片');
        return;
    }
    var i = 0, length = images.localId.length;
    images.serverId = [];
    function upload() {
      wx.uploadImage({
        localId: images.localId[i],
        success: function (res) {
          i++;
          images.serverId.push(res.serverId);
          insertValue(res.serverId);
          if (i < length) {
             upload();
          }else{
              $("#uploadImg").html("上传成功");
            //   alert("上传成功!");
          }
        },
        fail: function (res) {
           alert(JSON.stringify(res));
        }
      });
    }
    upload();     
  }
  function downLoadImg(){
      if (images.serverId.length === 0) {
      alert('请先使用 uploadImage 上传图片');
      return;
    }
    var i = 0, length = images.serverId.length;
    images.localId = [];
    function download() {
      wx.downloadImage({
        serverId: images.serverId[i],
        success: function (res) {
          i++;
          alert('已下载：' + i + '/' + length);
          images.localId.push(res.localId);
          console.log(res);
          if (i < length) {
            download();
          }
        }
      });
    }
    download();    
  }
</script>
  {template 'jsweixin'}
</html>